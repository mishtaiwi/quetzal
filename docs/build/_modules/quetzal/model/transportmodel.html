

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>quetzal.model.transportmodel &mdash; quetzal  documentation</title>
  

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> quetzal
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../quetzal.engine.html">quetzal.engine package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quetzal.model.html">quetzal.model package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quetzal.io.html">quetzal.io package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../quetzal.analysis.html">quetzal.analysis package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">quetzal</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>quetzal.model.transportmodel</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for quetzal.model.transportmodel</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">quetzal.analysis</span> <span class="kn">import</span> <span class="n">analysis</span>
<span class="kn">from</span> <span class="nn">quetzal.engine</span> <span class="kn">import</span> <span class="n">engine</span>
<span class="kn">from</span> <span class="nn">quetzal.engine.pathfinder</span> <span class="kn">import</span> <span class="n">PublicPathFinder</span>
<span class="kn">from</span> <span class="nn">quetzal.engine.park_and_ride_pathfinder</span> <span class="kn">import</span> <span class="n">ParkRidePathFinder</span> 
<span class="kn">from</span> <span class="nn">quetzal.engine.road_pathfinder</span> <span class="kn">import</span> <span class="n">RoadPathFinder</span>
<span class="kn">from</span> <span class="nn">quetzal.engine</span> <span class="kn">import</span> <span class="n">nested_logit</span>
<span class="kn">from</span> <span class="nn">quetzal.model</span> <span class="kn">import</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimalmodel</span><span class="p">,</span> <span class="n">parkridemodel</span>

<span class="kn">from</span> <span class="nn">syspy.assignment</span> <span class="kn">import</span> <span class="n">raw</span> <span class="k">as</span> <span class="n">raw_assignment</span>
<span class="kn">from</span> <span class="nn">syspy.assignment.raw</span> <span class="kn">import</span> <span class="n">fast_assign</span> <span class="k">as</span> <span class="n">assign</span>
<span class="kn">from</span> <span class="nn">syspy.skims</span> <span class="kn">import</span> <span class="n">skims</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>


<div class="viewcode-block" id="read_hdf"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.read_hdf">[docs]</a><span class="k">def</span> <span class="nf">read_hdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">TransportModel</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>


<div class="viewcode-block" id="read_json"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.read_json">[docs]</a><span class="k">def</span> <span class="nf">read_json</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">TransportModel</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">m</span></div>

<span class="n">track_args</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">track_args</span>
<span class="n">log</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">log</span>


<div class="viewcode-block" id="TransportModel"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel">[docs]</a><span class="k">class</span> <span class="nc">TransportModel</span><span class="p">(</span><span class="n">optimalmodel</span><span class="o">.</span><span class="n">OptimalModel</span><span class="p">,</span> <span class="n">parkridemodel</span><span class="o">.</span><span class="n">ParkRideModel</span><span class="p">):</span>

<div class="viewcode-block" id="TransportModel.step_distribution"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_distribution">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_distribution</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">deterrence_matrix</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">od_volume_from_zones_kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: zones</span>
<span class="sd">        * builds: volumes</span>

<span class="sd">        :param deterrence_matrix: an OD unstaked dataframe representing the disincentive to </span>
<span class="sd">            travel as distance/time/cost increases.</span>
<span class="sd">        :param od_volume_from_zones_kwargs: if the friction matrix is not</span>
<span class="sd">            provided, it will be automatically computed using a gravity distribution which</span>
<span class="sd">            uses the following parameters:</span>
<span class="sd">            * param power: (int) the gravity exponent</span>
<span class="sd">            * param intrazonal: (bool) set the intrazonal distance to 0 if False,</span>
<span class="sd">                compute a characteristic distance otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">od_volume_from_zones</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zones</span><span class="p">,</span>
            <span class="n">deterrence_matrix</span><span class="p">,</span>
            <span class="n">coordinates_unit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">coordinates_unit</span><span class="p">,</span>
            <span class="o">**</span><span class="n">od_volume_from_zones_kwargs</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TransportModel.step_pathfinder"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_pathfinder">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_pathfinder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">walk_on_road</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">complete</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: links, footpaths, zone_to_transit, zone_to_road</span>
<span class="sd">        * builds: pt_los</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">graph_links</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walk_on_road</span> <span class="o">=</span> <span class="n">walk_on_road</span>

        <span class="k">if</span> <span class="n">walk_on_road</span><span class="p">:</span>
            <span class="n">footpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">footpaths</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">footpaths</span><span class="p">[</span><span class="s1">&#39;walk_time&#39;</span><span class="p">]</span>
            <span class="n">ntlegs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone_to_road</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_nodes</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">footpaths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">footpaths</span>
            <span class="n">ntlegs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zone_to_transit</span>
            <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>

        <span class="c1">#TODO even with walk on road, transit nodes may not belong to road_nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">path_and_duration_from_links_and_ntlegs</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
            <span class="n">ntlegs</span><span class="o">=</span><span class="n">ntlegs</span><span class="p">,</span>
            <span class="n">pole_set</span><span class="o">=</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones</span><span class="o">.</span><span class="n">index</span><span class="p">),</span>
            <span class="n">footpaths</span><span class="o">=</span><span class="n">footpaths</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">complete</span><span class="p">:</span>        
            <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">path_analysis_od_matrix</span><span class="p">(</span>
                <span class="n">od_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">,</span> 
                <span class="n">links</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">nodes</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span>
            <span class="p">)</span></div>
  
<div class="viewcode-block" id="TransportModel.step_road_pathfinder"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_road_pathfinder">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_road_pathfinder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: zones, road_links, zone_to_road</span>
<span class="sd">        * builds: car_los, road_links</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">roadpathfinder</span> <span class="o">=</span> <span class="n">RoadPathFinder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">roadpathfinder</span><span class="o">.</span><span class="n">frank_wolfe</span><span class="p">(</span><span class="n">maxiters</span><span class="o">=</span><span class="n">maxiters</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">car_los</span> <span class="o">=</span> <span class="n">roadpathfinder</span><span class="o">.</span><span class="n">car_los</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span> <span class="o">=</span> <span class="n">roadpathfinder</span><span class="o">.</span><span class="n">road_links</span></div>

<div class="viewcode-block" id="TransportModel.step_pr_pathfinder"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_pr_pathfinder">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_pr_pathfinder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">path_analysis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="s1">&#39;zones&#39;</span><span class="p">,</span> <span class="s1">&#39;road_nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;road_links&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrity_test_collision</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">graph_links</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>
        <span class="n">parkridepathfinder</span> <span class="o">=</span> <span class="n">ParkRidePathFinder</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">parkridepathfinder</span><span class="o">.</span><span class="n">find_best_path</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pr_los</span> <span class="o">=</span> <span class="n">parkridepathfinder</span><span class="o">.</span><span class="n">paths</span>
        
        <span class="k">if</span> <span class="n">path_analysis</span><span class="p">:</span>
            <span class="n">analysis_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_nodes</span><span class="p">])</span>
            <span class="n">analysis_links</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pr_los</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">path_analysis_od_matrix</span><span class="p">(</span>
                <span class="n">od_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pr_los</span><span class="p">,</span>
                <span class="n">links</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">analysis_nodes</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span>
            <span class="p">)</span> <span class="c1"># analyse non vérifiée, prise directement depuis pt_los</span></div>

<div class="viewcode-block" id="TransportModel.step_pt_pathfinder"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_pt_pathfinder">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_pt_pathfinder</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">broken_routes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">broken_modes</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
        <span class="n">route_column</span><span class="o">=</span><span class="s1">&#39;route_id&#39;</span><span class="p">,</span>
        <span class="n">mode_column</span><span class="o">=</span><span class="s1">&#39;route_type&#39;</span><span class="p">,</span>
        <span class="n">boarding_time</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">speedup</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">walk_on_road</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="c1"># keep_graph=False,</span>
        <span class="n">keep_pathfinder</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">force</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">path_analysis</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: zones, links, footpaths, zone_to_road, zone_to_transit</span>
<span class="sd">        * builds: pt_los</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sets</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;links&#39;</span><span class="p">,</span> <span class="s1">&#39;zones&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">walk_on_road</span><span class="p">:</span>
            <span class="n">sets</span> <span class="o">+=</span> <span class="p">[</span><span class="s1">&#39;road_nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;road_links&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">force</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">integrity_test_collision</span><span class="p">(</span><span class="n">sets</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">graph_links</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">)</span>

        <span class="n">publicpathfinder</span> <span class="o">=</span> <span class="n">PublicPathFinder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">walk_on_road</span><span class="o">=</span><span class="n">walk_on_road</span><span class="p">)</span>
        <span class="n">publicpathfinder</span><span class="o">.</span><span class="n">find_best_paths</span><span class="p">(</span>
            <span class="n">broken_routes</span><span class="o">=</span><span class="n">broken_routes</span><span class="p">,</span> 
            <span class="n">broken_modes</span><span class="o">=</span><span class="n">broken_modes</span><span class="p">,</span> 
            <span class="n">route_column</span><span class="o">=</span><span class="n">route_column</span><span class="p">,</span>
            <span class="n">mode_column</span><span class="o">=</span><span class="n">mode_column</span><span class="p">,</span>
            <span class="n">speedup</span><span class="o">=</span><span class="n">speedup</span><span class="p">,</span>
            <span class="n">boarding_time</span><span class="o">=</span><span class="n">boarding_time</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># if keep_graph:</span>
        <span class="c1">#     self.nx_graph=publicpathfinder.nx_graph</span>
        
        <span class="k">if</span> <span class="n">keep_pathfinder</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publicpathfinder</span> <span class="o">=</span> <span class="n">publicpathfinder</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span> <span class="o">=</span> <span class="n">publicpathfinder</span><span class="o">.</span><span class="n">paths</span>
        <span class="n">analysis_nodes</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_nodes</span><span class="p">])</span> <span class="k">if</span> <span class="n">walk_on_road</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span>
        
        <span class="k">if</span> <span class="n">path_analysis</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">path_analysis_od_matrix</span><span class="p">(</span>
                <span class="n">od_matrix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">,</span>
                <span class="n">links</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
                <span class="n">nodes</span><span class="o">=</span><span class="n">analysis_nodes</span><span class="p">,</span>
                <span class="n">centroids</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">centroids</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="TransportModel.step_concatenate_los"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_concatenate_los">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_concatenate_los</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: pt_los, car_los</span>
<span class="sd">        * builds: los</span>
<span class="sd">        &quot;&quot;&quot;</span></div>

<div class="viewcode-block" id="TransportModel.step_modal_split"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_modal_split">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_modal_split</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">build_od_stack</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">modal_split_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: volumes, los</span>
<span class="sd">        * builds: od_stack, shared</span>

<span class="sd">        :param modal_split_kwargs: kwargs of engine.modal_split</span>

<span class="sd">        example:</span>
<span class="sd">        ::</span>
<span class="sd">            sm.step_modal_split(</span>
<span class="sd">                time_scale=1/1800,</span>
<span class="sd">                alpha_car=2,</span>
<span class="sd">                beta_car=600</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">shared</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">modal_split_from_volumes_and_los</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">,</span>
            <span class="o">**</span><span class="n">modal_split_kwargs</span>
        <span class="p">)</span>
        <span class="c1"># shared[&#39;distance_car&#39;] = shared[&#39;distance&#39;]</span>
        <span class="k">if</span> <span class="n">build_od_stack</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">od_stack</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">volume_analysis_od_matrix</span><span class="p">(</span><span class="n">shared</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">shared</span> <span class="o">=</span> <span class="n">shared</span></div>

<div class="viewcode-block" id="TransportModel.compute_los_volume"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.compute_los_volume">[docs]</a>    <span class="k">def</span> <span class="nf">compute_los_volume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">keep_segments</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>

        <span class="n">los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">time_expanded</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span>
    
        <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>
        <span class="n">probabilities</span> <span class="o">=</span> <span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>

        <span class="n">shared_cols</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">los</span><span class="o">.</span><span class="n">columns</span><span class="p">)))</span>
        <span class="n">on</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">shared_cols</span> <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span><span class="p">,</span> <span class="s1">&#39;wished_departure_time&#39;</span><span class="p">]]</span>

        <span class="n">left</span> <span class="o">=</span> <span class="n">los</span><span class="p">[</span><span class="n">on</span> <span class="o">+</span> <span class="n">probabilities</span><span class="p">]</span>
        <span class="n">left</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="o">.</span><span class="n">index</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">los</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">probabilities</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="n">df</span><span class="p">[</span><span class="n">segments</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">:</span>
            <span class="n">los</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">los</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
            <span class="n">los_volumes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;path_id&#39;</span><span class="p">)[[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">segments</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="n">path_id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">[</span><span class="s1">&#39;path_id&#39;</span><span class="p">])</span>
            <span class="n">volume_values</span> <span class="o">=</span> <span class="n">los_volumes</span><span class="o">.</span><span class="n">reindex</span><span class="p">(</span><span class="n">path_id_list</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">los_volumes</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># create_columns</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">los_volumes</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">=</span> <span class="n">volume_values</span></div>

<div class="viewcode-block" id="TransportModel.step_assignment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">step_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">road</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">boardings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">boarding_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">alightings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">alighting_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">transfers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">segmented</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">time_expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">compute_los_volume</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>

        <span class="k">if</span> <span class="n">compute_los_volume</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">compute_los_volume</span><span class="p">(</span><span class="n">time_expanded</span><span class="o">=</span><span class="n">time_expanded</span><span class="p">)</span>
        <span class="n">los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;link_path&#39;</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">road</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="k">if</span> <span class="s1">&#39;road_link_list&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">to_assign</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;road_link_list&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="s1">&#39;volume&#39;</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
                    <span class="n">to_assign</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> 
                    <span class="n">to_assign</span><span class="p">[</span><span class="s1">&#39;road_link_list&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            
        <span class="k">if</span> <span class="n">boardings</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">boarding_links</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;to assign boardings on links pass boarding_links=True&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">boarding_links</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;boarding_links&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;boardings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">boardings</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;boardings&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;boardings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="n">alighting_links</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;alighting_links&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;alightings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">alightings</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;alightings&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="s1">&#39;alightings&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            
        <span class="k">if</span> <span class="n">transfers</span><span class="p">:</span>
            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;transfers&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span> <span class="s1">&#39;transfers&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">segmented</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmented_assigment</span><span class="p">(</span>
                <span class="n">road</span><span class="o">=</span><span class="n">road</span><span class="p">,</span> 
                <span class="n">boardings</span><span class="o">=</span><span class="n">boardings</span><span class="p">,</span> <span class="n">alightings</span><span class="o">=</span><span class="n">alightings</span><span class="p">,</span> <span class="n">transfers</span><span class="o">=</span><span class="n">transfers</span><span class="p">,</span>
                <span class="n">aggregated_los</span><span class="o">=</span><span class="n">los</span>
            <span class="p">)</span></div>
        
<div class="viewcode-block" id="TransportModel.segmented_assigment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.segmented_assigment">[docs]</a>    <span class="k">def</span> <span class="nf">segmented_assigment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">road</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">boardings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">alightings</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
        <span class="n">transfers</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">aggregated_los</span><span class="o">=</span><span class="kc">None</span>
        <span class="p">):</span>
        <span class="n">los</span> <span class="o">=</span> <span class="n">aggregated_los</span> <span class="k">if</span> <span class="n">aggregated_los</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span>
    
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>

            <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;link_path&#39;</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">road</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;pt&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[</span><span class="s1">&#39;road_link_list&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">boardings</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;boarding_links&#39;</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;boardings&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

                <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;boardings&#39;</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;boardings&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">alightings</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;alighting_links&#39;</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;alightings&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

                <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;alightings&#39;</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;alightings&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">transfers</span><span class="p">:</span>
                <span class="n">column</span> <span class="o">=</span> <span class="s1">&#39;transfers&#39;</span>
                <span class="n">l</span> <span class="o">=</span> <span class="n">los</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="n">column</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;transfers&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assign</span><span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="n">segment</span><span class="p">],</span> <span class="n">l</span><span class="p">[</span><span class="n">column</span><span class="p">])</span></div>

<div class="viewcode-block" id="TransportModel.step_pt_assignment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_pt_assignment">[docs]</a>    <span class="nd">@track_args</span>
    <span class="k">def</span> <span class="nf">step_pt_assignment</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">volume_column</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">on_road_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">split_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assignment step</span>
<span class="sd">            * requires: links, nodes, pt_los, road_links, volumes, path_probabilities</span>
<span class="sd">            * builds: loaded_links, loaded_nodes, add load to road_links</span>

<span class="sd">        :param volume_column: volume column of self.volumes to assign. If none, all columns will be assigned</span>
<span class="sd">        :param on_road_links: if True, performs pt assignment on road_links as well</span>
<span class="sd">        :param split_by: path categories to be tracked in the assignment. Must be a column of self.pt_los</span>

<span class="sd">        example:</span>
<span class="sd">        ::</span>
<span class="sd">            sm.step_assignment(</span>
<span class="sd">                    volume_column=None,</span>
<span class="sd">                    on_road_links=False,</span>
<span class="sd">                    split_by=&#39;route_type&#39;,</span>
<span class="sd">                    boardings=True,</span>
<span class="sd">                    alightings=True,</span>
<span class="sd">                    transfers=True</span>
<span class="sd">                }</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">volume_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmented_pt_assignment</span><span class="p">(</span>
                <span class="n">on_road_links</span><span class="o">=</span><span class="n">on_road_links</span><span class="p">,</span>
                <span class="n">split_by</span><span class="o">=</span><span class="n">split_by</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="k">return</span> 

        <span class="c1"># When split_by is not None, this call could be replaced by a sum, provided </span>
        <span class="c1"># prior dumb definition of loaded_links and loaded_nodes </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">loaded_links_and_nodes</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
            <span class="n">volumes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span>
            <span class="n">path_finder_stack</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">,</span>
            <span class="n">volume_column</span><span class="o">=</span><span class="n">volume_column</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>

        <span class="c1"># Rename columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">volume_column</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">)},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">volume_column</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">)},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;boardings&#39;</span><span class="p">,</span> <span class="s1">&#39;alightings&#39;</span><span class="p">,</span> <span class="s1">&#39;transfers&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">)},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">)},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Group assignment</span>
        <span class="k">if</span> <span class="n">split_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">[</span><span class="n">split_by</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="c1"># TODO remove rows with empty link_path</span>
                <span class="n">group_pt_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">[</span><span class="n">split_by</span><span class="p">]</span><span class="o">==</span><span class="n">group</span><span class="p">]</span>
                <span class="n">group_loaded_links</span><span class="p">,</span> <span class="n">group_loaded_nodes</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">loaded_links_and_nodes</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">links</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span>
                    <span class="n">volumes</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span>
                    <span class="n">path_finder_stack</span><span class="o">=</span><span class="n">group_pt_los</span><span class="p">,</span>
                    <span class="n">volume_column</span><span class="o">=</span><span class="n">volume_column</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span>
                <span class="p">)</span>
                <span class="c1"># Append results columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group_loaded_links</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[(</span><span class="s1">&#39;load&#39;</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group_loaded_nodes</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;boardings&#39;</span><span class="p">,</span> <span class="s1">&#39;alightings&#39;</span><span class="p">,</span> <span class="s1">&#39;transfers&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group_loaded_links</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[(</span><span class="n">col</span><span class="p">,</span> <span class="n">volume_column</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="o">=</span> <span class="n">group_loaded_nodes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

        <span class="c1"># Assignment on road_links</span>
        <span class="k">if</span> <span class="n">on_road_links</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="s1">&#39;road_link_path&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="c1"># create road_link_path column from networkcasted linkss if not already defined</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_analysis_road_link_path</span><span class="p">()</span>

            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span><span class="p">])</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;to_assign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[(</span><span class="n">volume_column</span> <span class="p">,</span><span class="s1">&#39;probability&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="n">merged</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">split_by</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">def</span> <span class="nf">assign_group</span><span class="p">(</span><span class="n">g</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">raw_assignment</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;to_assign&#39;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;road_link_path&#39;</span><span class="p">])</span>
                    <span class="k">return</span> <span class="n">result</span>
                <span class="n">group_assigned</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">split_by</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">assign_group</span><span class="p">)</span>
                <span class="n">assigned</span> <span class="o">=</span> <span class="n">group_assigned</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                <span class="c1"># Add empty groups</span>
                <span class="k">for</span> <span class="n">empty</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">assigned</span><span class="o">.</span><span class="n">columns</span><span class="p">))):</span>
                    <span class="n">assigned</span><span class="p">[</span><span class="n">empty</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[[(</span><span class="n">volume_column</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]]</span> <span class="o">=</span> <span class="n">assigned</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">]]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span> <span class="o">=</span>  <span class="n">assigned</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

            <span class="k">else</span><span class="p">:</span> <span class="c1"># no groups</span>
                <span class="n">assigned</span> <span class="o">=</span> <span class="n">raw_assignment</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;to_assign&#39;</span><span class="p">],</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;road_link_path&#39;</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span> <span class="o">=</span> <span class="n">assigned</span><span class="p">[</span><span class="s1">&#39;volume&#39;</span><span class="p">]</span>

            <span class="c1"># todo remove &#39;load&#39; from analysis module: </span>
            <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="n">volume_column</span><span class="p">]</span></div>

<div class="viewcode-block" id="TransportModel.segmented_pt_assignment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.segmented_pt_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">segmented_pt_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">split_by</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">on_road_links</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs pt assignment for all demand segments.</span>
<span class="sd">        Requires computed path probabilities in pt_los for each segment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>


        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">iterator</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="c1"># Assign demand segment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">step_pt_assignment</span><span class="p">(</span>
                <span class="n">volume_column</span><span class="o">=</span><span class="n">segment</span><span class="p">,</span>
                <span class="n">path_pivot_column</span><span class="o">=</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">),</span>
                <span class="n">split_by</span><span class="o">=</span><span class="n">split_by</span><span class="p">,</span>
                <span class="n">on_road_links</span><span class="o">=</span><span class="n">on_road_links</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span>
            <span class="p">)</span>
            <span class="c1"># Update links and nodes to keep results as loaded links and nodes</span>
            <span class="c1"># are erased at each call of step_pt_assignment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">links</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span>

        <span class="c1"># Group assignment results: sum over demand segments</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pt_los</span><span class="p">[</span><span class="n">split_by</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">KeyError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span>
        <span class="c1"># Add boardings, alightings and transfers if processed</span>
        <span class="n">cols</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;boardings&#39;</span><span class="p">,</span> <span class="s1">&#39;alightings&#39;</span><span class="p">,</span> <span class="s1">&#39;transfers&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
                <span class="n">name</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="n">g</span><span class="p">])</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="nb">tuple</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="n">s</span><span class="p">])</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_links</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">on_road_links</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">groups</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">group</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[[(</span><span class="n">s</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="o">.</span><span class="n">drop</span><span class="p">([(</span><span class="n">s</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">]]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">segments</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="TransportModel.step_car_assignment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_car_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">step_car_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">volume_column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assignment step</span>
<span class="sd">            * requires: road_links, car_los, road_links, volumes, path_probabilities</span>
<span class="sd">            * builds: loaded_road_links</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">volume_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmented_car_assignment</span><span class="p">()</span></div>

<div class="viewcode-block" id="TransportModel.segmented_car_assignment"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.segmented_car_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">segmented_car_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="n">segments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">segments</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">iterator</span><span class="o">.</span><span class="n">desc</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">car_los</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">volumes</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span><span class="p">])</span>
            <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;to_assign&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[(</span><span class="n">segment</span> <span class="p">,</span><span class="s1">&#39;probability&#39;</span><span class="p">)]</span> <span class="o">*</span> <span class="n">merged</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="n">raw_assignment</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">merged</span><span class="p">[</span><span class="s1">&#39;to_assign&#39;</span><span class="p">],</span> <span class="n">merged</span><span class="p">[</span><span class="s1">&#39;link_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">assigned</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">road_links</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span></div>
	<span class="c1">#TODO Merge conflict: TO CHECK WITH ACCRA        </span>
	<span class="c1"># self.road_links.drop(columns, 1, inplace=True)</span>
        <span class="c1"># if not &#39;load&#39; in self.road_links.columns:</span>
        <span class="c1">#    self.road_links[&#39;load&#39;] = 0</span>
        <span class="c1"># self.road_links[&#39;load&#39;] += self.road_links[(&#39;all&#39;,&#39;car&#39;)]</span>
        

    <span class="c1">#TODO move all utility features to another object / file</span>

<div class="viewcode-block" id="TransportModel.analysis_mode_utility"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.analysis_mode_utility">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_mode_utility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">segments</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">time_expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: mode_utility, los, utility_values</span>
<span class="sd">        * builds: los</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>

            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">):</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">analysis_mode_utility</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="n">segment</span><span class="p">,</span> <span class="n">time_expanded</span><span class="o">=</span><span class="n">time_expanded</span><span class="p">)</span>
            <span class="k">return</span> 
        <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
            <span class="n">logit_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logit_los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span>
        <span class="n">mode_utility</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_utility</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="c1"># route type utilities</span>
        <span class="n">rtu</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">rt</span><span class="p">:</span> <span class="n">get_combined_mode_utility</span><span class="p">(</span>
                <span class="n">rt</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">mode_utility</span><span class="o">=</span><span class="n">mode_utility</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">rt</span> <span class="ow">in</span> <span class="n">logit_los</span><span class="p">[</span><span class="s1">&#39;route_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="p">}</span>
        <span class="n">logit_los</span><span class="p">[</span><span class="s1">&#39;mode_utility&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logit_los</span><span class="p">[</span><span class="s1">&#39;route_types&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">rtu</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
        
        <span class="n">utility_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_values</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">utility_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">logit_los</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">logit_los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">logit_los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">logit_los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span></div>
        
<div class="viewcode-block" id="TransportModel.analysis_utility"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.analysis_utility">[docs]</a>    <span class="k">def</span> <span class="nf">analysis_utility</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="s1">&#39;root&#39;</span><span class="p">,</span> <span class="n">time_expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: mode_utility, los, utility_values</span>
<span class="sd">        * builds: los</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">segment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">segment</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analysis_mode_utility</span><span class="p">(</span><span class="n">how</span><span class="o">=</span><span class="n">how</span><span class="p">,</span> <span class="n">segment</span><span class="o">=</span><span class="n">segment</span><span class="p">,</span> <span class="n">time_expanded</span><span class="o">=</span><span class="n">time_expanded</span><span class="p">)</span>
            <span class="k">return</span> 
        <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
            <span class="n">los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">los</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span>
        
        <span class="n">utility_values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">utility_values</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">u</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">utility_values</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">u</span> <span class="o">+=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">los</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span></div>

<div class="viewcode-block" id="TransportModel.initialize_logit"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.initialize_logit">[docs]</a>    <span class="k">def</span> <span class="nf">initialize_logit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">zones</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">zones</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
        <span class="n">od</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_product</span><span class="p">([</span><span class="n">zones</span><span class="p">,</span> <span class="n">zones</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">od_probabilities</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">od_utilities</span> <span class="o">=</span> <span class="n">od</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="TransportModel.step_logit"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.TransportModel.step_logit">[docs]</a>    <span class="k">def</span> <span class="nf">step_logit</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">time_expanded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">decimals</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
        <span class="n">n_paths_max</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nchunks</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
        <span class="n">workers</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">keep_od_tables</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        * requires: mode_nests, logit_scales, los</span>
<span class="sd">        * builds: los, od_utilities, od_probabilities, path_utilities, path_probabilities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># concatenate paths</span>
        <span class="n">od_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;origin&#39;</span><span class="p">,</span> <span class="s1">&#39;destination&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
            <span class="n">od_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;wished_departure_time&#39;</span><span class="p">)</span>
        <span class="n">to_concat</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
            <span class="n">keep_columns</span> <span class="o">=</span> <span class="n">od_cols</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;route_type&#39;</span><span class="p">,</span>  <span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">)]</span>
            <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span><span class="p">[</span><span class="n">keep_columns</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">[</span><span class="n">keep_columns</span><span class="p">]</span>

            <span class="n">paths</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;utility&#39;</span><span class="p">):</span> <span class="s1">&#39;utility&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">paths</span> <span class="o">=</span> <span class="n">paths</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;utility&#39;</span><span class="p">])</span>
            <span class="n">paths</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">segment</span>
            <span class="n">to_concat</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
        <span class="n">segmented_paths</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">to_concat</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span> <span class="c1"># all the segments can be proccessed together</span>
            <span class="c1"># assert all logit scales are the same and pick one</span>
            <span class="n">logit_scales</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logit_scales</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">logit_scales</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">logit_scales</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
            <span class="n">nls</span> <span class="o">=</span> <span class="n">logit_scales</span><span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="c1"># assert all mode_nests are the same and pick one</span>
            <span class="n">mode_nests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_nests</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">T</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">mode_nests</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="n">mode_nests</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;root&#39;</span><span class="p">]</span>
            <span class="n">nests</span> <span class="o">=</span> <span class="n">mode_nests</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">)[</span><span class="s1">&#39;route_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>

            <span class="n">p</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">nested_logit</span><span class="o">.</span><span class="n">nested_logit_from_paths</span><span class="p">(</span>
                <span class="n">segmented_paths</span><span class="p">,</span> 
                <span class="n">od_cols</span><span class="p">,</span>
                <span class="n">mode_nests</span><span class="o">=</span><span class="n">nests</span><span class="p">,</span> <span class="n">phi</span><span class="o">=</span><span class="n">nls</span><span class="p">,</span>
                <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">,</span> <span class="n">n_paths_max</span><span class="o">=</span><span class="n">n_paths_max</span><span class="p">,</span>
                <span class="n">nchunks</span><span class="o">=</span><span class="n">nchunks</span><span class="p">,</span> <span class="n">workers</span><span class="o">=</span><span class="n">workers</span><span class="p">,</span>
                <span class="n">return_od_tables</span><span class="o">=</span><span class="n">keep_od_tables</span>
            <span class="p">)</span>

        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="n">p_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mu_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">mp_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
                <span class="n">mode_nests</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mode_nests</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">segment</span><span class="p">)[</span><span class="s1">&#39;route_type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span>
                        <span class="k">lambda</span> <span class="n">s</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">s</span><span class="p">))</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">nls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">logit_scales</span><span class="p">[</span><span class="n">segment</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="n">segmented_paths</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segmented_paths</span><span class="p">[</span><span class="s1">&#39;segment&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">segment</span><span class="p">]</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">mp</span> <span class="o">=</span> <span class="n">nested_logit</span><span class="o">.</span><span class="n">nested_logit_from_paths</span><span class="p">(</span>
                    <span class="n">paths</span><span class="p">,</span> 
                    <span class="n">mode_nests</span><span class="o">=</span><span class="n">mode_nests</span><span class="p">,</span>
                    <span class="n">phi</span><span class="o">=</span><span class="n">nls</span><span class="p">,</span>
                    <span class="n">od_cols</span><span class="o">=</span><span class="n">od_cols</span><span class="p">,</span>
                    <span class="n">decimals</span><span class="o">=</span><span class="n">decimals</span><span class="p">,</span>
                    <span class="n">n_paths_max</span><span class="o">=</span><span class="n">n_paths_max</span><span class="p">,</span>

                <span class="p">)</span>
                <span class="n">p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="n">mu_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
                <span class="n">mp_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mp</span><span class="p">)</span>
                
            <span class="n">p</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">p_list</span><span class="p">)</span>
            <span class="n">mu</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mu_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">mp</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">mp_list</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">p</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="s1">&#39;segment&#39;</span><span class="p">,</span> <span class="s1">&#39;index&#39;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">segments</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">time_expanded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">te_los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segment</span><span class="p">][</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">los</span><span class="p">[(</span><span class="n">segment</span><span class="p">,</span> <span class="s1">&#39;probability&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segment</span><span class="p">][</span><span class="s1">&#39;probability&#39;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">probabilities</span> <span class="o">=</span> <span class="n">mp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">utilities</span> <span class="o">=</span> <span class="n">mu</span></div></div>

    
<div class="viewcode-block" id="get_combined_mode_utility"><a class="viewcode-back" href="../../../quetzal.model.transportmodel.html#quetzal.model.transportmodel.get_combined_mode_utility">[docs]</a><span class="k">def</span> <span class="nf">get_combined_mode_utility</span><span class="p">(</span><span class="n">route_types</span><span class="p">,</span> <span class="n">mode_utility</span><span class="p">,</span>  <span class="n">how</span><span class="o">=</span><span class="s1">&#39;min&#39;</span><span class="p">,):</span>
    <span class="n">utilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">mode_utility</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span> <span class="k">for</span> <span class="n">mode</span> <span class="ow">in</span> <span class="n">route_types</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">utilities</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">how</span><span class="o">==</span><span class="s1">&#39;min&#39;</span><span class="p">:</span> <span class="c1"># worse mode</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">how</span><span class="o">==</span><span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="c1"># best mode</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">how</span><span class="o">==</span><span class="s1">&#39;sum&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">how</span><span class="o">==</span><span class="s1">&#39;mean&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">utilities</span><span class="p">)</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2018, Systra.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>